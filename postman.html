<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内网Postman调用工具</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 1.5rem;
        }
        
        .main-content {
            display: flex;
            min-height: 500px;
        }
        
        .request-section {
            flex: 1;
            padding: 20px;
            border-right: 1px solid #eee;
        }
        
        .response-section {
            flex: 1;
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: monospace;
        }
        
        .method-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .method-option {
            padding: 8px 15px;
            background-color: #ecf0f1;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .method-option.active {
            color: white;
        }
        
        .method-get.active {
            background-color: #3498db;
        }
        
        .method-post.active {
            background-color: #2ecc71;
        }
        
        .method-put.active {
            background-color: #f39c12;
        }
        
        .method-delete.active {
            background-color: #e74c3c;
        }
        
        .headers-container {
            margin-top: 10px;
        }
        
        .header-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .header-row input {
            flex: 1;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        /* Loading状态样式 */
        .btn-primary.loading {
            opacity: 0.7;
            cursor: not-allowed;
            position: relative;
            padding-right: 35px;
        }
        
        .btn-primary.loading::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            width: 16px;
            height: 16px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .btn-secondary {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #c0392b;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .response-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
        }
        
        .tab.active {
            border-bottom: 2px solid #3498db;
            color: #3498db;
            font-weight: 500;
        }
        
        .response-content {
            min-height: 300px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            overflow: auto;
            white-space: pre-wrap;
            font-family: monospace;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .status-code {
            font-weight: 500;
        }
        
        .status-time {
            color: #7f8c8d;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .request-section {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>内网Postman调用工具</h1>
            <button id="sendBtn" class="btn btn-primary">发送请求</button>
        </header>
        
        <div class="main-content">
            <section class="request-section">
                <div class="form-group">
                    <label for="url">请求URL</label>
                    <input type="text" id="url" placeholder="https://example.com/api" value="https://jsonplaceholder.typicode.com/posts">
                </div>
                
                <div class="form-group">
                    <label>请求方法</label>
                    <div class="method-selector">
                        <div class="method-option method-get active" data-method="GET">GET</div>
                        <div class="method-option method-post" data-method="POST">POST</div>
                        <div class="method-option method-put" data-method="PUT">PUT</div>
                        <div class="method-option method-delete" data-method="DELETE">DELETE</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>请求头</label>
                    <div class="headers-container" id="headersContainer">
                        <div class="header-row">
                            <input type="text" placeholder="键" class="header-key">
                            <input type="text" placeholder="值" class="header-value">
                            <button class="btn btn-secondary btn-small remove-header">删除</button>
                        </div>
                    </div>
                    <button id="addHeaderBtn" class="btn btn-small">添加请求头</button>
                </div>
                
                <div class="form-group" id="bodySection">
                    <label for="requestBody">请求体 (JSON)</label>
                    <textarea id="requestBody" placeholder='{"key": "value"}'></textarea>
                </div>
            </section>
            
            <section class="response-section">
                <div class="status-bar">
                    <div class="status-code" id="statusCode">状态: 未发送</div>
                    <div class="status-time" id="responseTime">时间: -</div>
                </div>
                
                <div class="response-tabs">
                    <div class="tab active" data-tab="body">响应体</div>
                    <div class="tab" data-tab="headers">响应头</div>
                </div>
                
                <div class="response-content" id="responseBody">
                    {/* 响应内容将显示在这里 */}
                </div>
                <div class="response-content hidden" id="responseHeaders">
                    {/* 响应头将显示在这里 */}
                </div>
            </section>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 元素引用
            const methodOptions = document.querySelectorAll('.method-option');
            const urlInput = document.getElementById('url');
            const headersContainer = document.getElementById('headersContainer');
            const addHeaderBtn = document.getElementById('addHeaderBtn');
            const bodySection = document.getElementById('bodySection');
            const requestBody = document.getElementById('requestBody');
            const sendBtn = document.getElementById('sendBtn');
            const statusCode = document.getElementById('statusCode');
            const responseTime = document.getElementById('responseTime');
            const responseBody = document.getElementById('responseBody');
            const responseHeaders = document.getElementById('responseHeaders');
            const tabs = document.querySelectorAll('.tab');
            
            // 当前选中的方法
            let currentMethod = 'GET';
            
            // 方法选择处理
            methodOptions.forEach(option => {
                option.addEventListener('click', function() {
                    methodOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    currentMethod = this.dataset.method;
                    
                    // 如果是GET或DELETE方法，隐藏请求体区域
                    if (currentMethod === 'GET' || currentMethod === 'DELETE') {
                        bodySection.style.display = 'none';
                    } else {
                        bodySection.style.display = 'block';
                    }
                });
            });
            
            // 添加请求头
            addHeaderBtn.addEventListener('click', function() {
                const headerRow = document.createElement('div');
                headerRow.className = 'header-row';
                headerRow.innerHTML = `
                    <input type="text" placeholder="键" class="header-key">
                    <input type="text" placeholder="值" class="header-value">
                    <button class="btn btn-secondary btn-small remove-header">删除</button>
                `;
                headersContainer.appendChild(headerRow);
                
                // 为新行添加删除事件
                headerRow.querySelector('.remove-header').addEventListener('click', function() {
                    headersContainer.removeChild(headerRow);
                });
            });
            
            // 删除请求头事件委托
            headersContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-header')) {
                    const headerRow = e.target.closest('.header-row');
                    if (headerRow && headersContainer.children.length > 1) {
                        headersContainer.removeChild(headerRow);
                    }
                }
            });
            
            // 标签页切换
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const tabType = this.dataset.tab;
                    if (tabType === 'body') {
                        responseBody.classList.remove('hidden');
                        responseHeaders.classList.add('hidden');
                    } else {
                        responseBody.classList.add('hidden');
                        responseHeaders.classList.remove('hidden');
                    }
                });
            });
            
            // 发送请求
            sendBtn.addEventListener('click', function() {
                const url = urlInput.value.trim();
                if (!url) {
                    alert('请输入URL');
                    return;
                }
                
                // 添加loading状态
                this.disabled = true;
                this.classList.add('loading');
                const originalText = this.textContent;
                this.textContent = '发送中';
                
                // 收集请求头
                const headers = {};
                const headerRows = headersContainer.querySelectorAll('.header-row');
                headerRows.forEach(row => {
                    const key = row.querySelector('.header-key').value.trim();
                    const value = row.querySelector('.header-value').value.trim();
                    if (key && value) {
                        headers[key] = value;
                    }
                });
                
                // 准备请求选项
                const options = {
                    method: currentMethod,
                    headers: headers
                };
                
                // 如果是POST/PUT方法且有请求体，添加请求体
                if ((currentMethod === 'POST' || currentMethod === 'PUT') && requestBody.value.trim()) {
                    try {
                        // 尝试解析JSON
                        const body = JSON.parse(requestBody.value);
                        options.body = JSON.stringify(body);
                        // 如果没有设置Content-Type，自动添加
                        if (!headers['Content-Type']) {
                            options.headers['Content-Type'] = 'application/json';
                        }
                    } catch (e) {
                        alert('请求体不是有效的JSON格式');
                        // 清除loading状态 - 使用sendBtn引用而不是this，确保作用域正确
                        sendBtn.disabled = false;
                        sendBtn.classList.remove('loading');
                        sendBtn.textContent = originalText;
                        return;
                    }
                }
                
                // 记录开始时间
                const startTime = Date.now();
                
                // 保存请求参数到localStorage
                try {
                    const requestParams = {
                        url: url,
                        method: currentMethod,
                        headers: headers,
                        body: (currentMethod === 'POST' || currentMethod === 'PUT') && requestBody.value.trim() ? requestBody.value : null
                    };
                    localStorage.setItem('postman_request_params', JSON.stringify(requestParams));
                    console.log('请求参数已成功保存到localStorage:', requestParams);
                } catch (e) {
                    console.warn('保存请求参数失败:', e);
                }
                
                // 发送请求
                fetch(url, options)
                    .then(response => {
                        // 计算响应时间
                        const endTime = Date.now();
                        const duration = endTime - startTime;
                        
                        // 更新状态码和响应时间
                        statusCode.textContent = `状态: ${response.status} ${response.statusText}`;
                        statusCode.style.color = response.status >= 400 ? '#e74c3c' : '#2ecc71';
                        responseTime.textContent = `时间: ${duration}ms`;
                        
                        // 收集响应头
                        let headersText = '';
                        response.headers.forEach((value, key) => {
                            headersText += `${key}: ${value}\n`;
                        });
                        responseHeaders.textContent = headersText;
                        
                        // 处理响应体
                        return response.text().then(text => {
                            try {
                                // 尝试格式化为JSON
                                const json = JSON.parse(text);
                                responseBody.textContent = JSON.stringify(json, null, 2);
                            } catch (e) {
                                // 如果不是JSON，直接显示文本
                                responseBody.textContent = text;
                            }
                        });
                    })
                    .catch(error => {
                        statusCode.textContent = `错误: ${error.message}`;
                        statusCode.style.color = '#e74c3c';
                        responseBody.textContent = `请求失败: ${error.message}`;
                    })
                    .finally(() => {
                        // 恢复按钮的正常状态
                        sendBtn.disabled = false;
                        sendBtn.classList.remove('loading');
                        sendBtn.textContent = originalText;
                    });
            });
            
            // 初始化：默认隐藏POST请求体
            bodySection.style.display = 'none';
            
            // 从localStorage加载保存的请求参数
            try {
                const savedParams = localStorage.getItem('postman_request_params');
                if (savedParams) {
                    const params = JSON.parse(savedParams);
                    console.log('从localStorage加载的请求参数:', params);
                    
                    // 应用URL
                    if (params.url) {
                        urlInput.value = params.url;
                    }
                    
                    // 应用请求方法
                    if (params.method) {
                        currentMethod = params.method;
                        methodOptions.forEach(option => {
                            if (option.dataset.method === currentMethod) {
                                option.classList.add('active');
                            } else {
                                option.classList.remove('active');
                            }
                        });
                        
                        // 显示或隐藏请求体区域
                        if (currentMethod === 'GET' || currentMethod === 'DELETE') {
                            bodySection.style.display = 'none';
                        } else {
                            bodySection.style.display = 'block';
                        }
                    }
                    
                    // 应用请求头
                    if (params.headers && Object.keys(params.headers).length > 0) {
                        // 清空现有的请求头行，只保留一行
                        while (headersContainer.children.length > 1) {
                            headersContainer.removeChild(headersContainer.lastChild);
                        }
                        
                        // 添加保存的请求头
                        Object.entries(params.headers).forEach(([key, value], index) => {
                            if (index === 0) {
                                // 使用第一行
                                const firstRow = headersContainer.children[0];
                                firstRow.querySelector('.header-key').value = key;
                                firstRow.querySelector('.header-value').value = value;
                            } else {
                                // 添加新行
                                const headerRow = document.createElement('div');
                                headerRow.className = 'header-row';
                                headerRow.innerHTML = `
                                    <input type="text" placeholder="键" class="header-key" value="${key}">
                                    <input type="text" placeholder="值" class="header-value" value="${value}">
                                    <button class="btn btn-secondary btn-small remove-header">删除</button>
                                `;
                                headersContainer.appendChild(headerRow);
                                
                                // 添加删除事件
                                headerRow.querySelector('.remove-header').addEventListener('click', function() {
                                    headersContainer.removeChild(headerRow);
                                });
                            }
                        });
                    }
                    
                    // 应用请求体
                    if (params.body) {
                        requestBody.value = params.body;
                    }
                } else {
                    // 如果没有保存的参数，使用默认示例请求体
                    requestBody.value = JSON.stringify({
                        title: 'foo',
                        body: 'bar',
                        userId: 1
                    }, null, 2);
                }
            } catch (e) {
                console.warn('加载请求参数失败:', e);
                // 加载失败时使用默认示例请求体
                requestBody.value = JSON.stringify({
                    title: 'foo',
                    body: 'bar',
                    userId: 1
                }, null, 2);
            }
        });
    </script>
</body>
</html>